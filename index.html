<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>D·ªãch V·ª• Online</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    select, input, textarea, button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #mainService, #subService {
      font-size: 18px;
      font-weight: 500;
    }
    #mainService option, #subService option {
      font-size: 18px;
    }
    button {
      background: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #218838;
    }
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    input[readonly] {
      background: #fff !important;
      color: #000;
      cursor: pointer;
    }
    .row {
      display: flex;
      gap: 6px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ch·ªçn D·ªãch V·ª•</h2>
    <label>D·ªãch v·ª• ch√≠nh:</label>
    <select id="mainService" onchange="loadSubService()">
      <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
    </select>

    <label>D·ªãch v·ª• con:</label>
    <select id="subService" onchange="buildForm()">
      <option value="">-- Ch·ªçn d·ªãch v·ª• con --</option>
    </select>

    <form id="dynamicForm" onsubmit="submitForm(event)"></form>
    <div id="messageBox" class="message"></div>
  </div>

  <!-- Modal b·∫£n ƒë·ªì -->
  <div id="mapModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="width:90%; max-width:600px; background:#fff; margin:40px auto; padding:10px; border-radius:6px;">
      <div id="map" style="height:400px;"></div>
      <p id="addressDisplay" style="padding:10px; font-weight:bold;"></p>
      <div style="text-align:right; margin-top:10px;">
        <button onclick="confirmLocation()">X√°c nh·∫≠n</button>
        <button onclick="closeMapModal()" style="background:#ccc; color:#000;">H·ªßy</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const serviceConfig = {
      "Taxi": {
        "S√¢n bay": ["diem_don", "diem_den", "thoi_gian_don", "dien_thoai", "yeu_cau_taxi"]
      },
      "Giao h√†ng / V·∫≠n chuy·ªÉn": {
        "Chuy·ªÉn nh√† tr·ªçn g√≥i": ["diem_don", "diem_den", "thoi_gian", "mo_ta", "yeu_cau", "dien_thoai"]
      }
    };

    const fieldLabels = {
      ten: "H·ªç t√™n",
      dien_thoai: "S·ªë ƒëi·ªán tho·∫°i",
      dia_diem: "ƒê·ªãa ƒëi·ªÉm",
      diem_don: "ƒêi·ªÉm ƒë√≥n",
      diem_den: "ƒêi·ªÉm ƒë·∫øn",
      tinh_trang: "T√¨nh tr·∫°ng",
      thoi_gian: "Th·ªùi gian",
      thoi_gian_don: "Th·ªùi gian ƒë√≥n",
      thoi_diem_can: "Th·ªùi ƒëi·ªÉm c·∫ßn",
      khu_vuc: "Khu v·ª±c mu·ªën ƒë·∫∑t",
      mo_ta: "M√¥ t·∫£",
      yeu_cau: "Y√™u c·∫ßu",
      yeu_cau_taxi: "Y√™u c·∫ßu (Lo·∫°i xe, s·ªë ch·ªó...)"
    };

    window.onload = () => {
      const mainSel = document.getElementById("mainService");
      for (let main in serviceConfig) {
        mainSel.innerHTML += `<option value="${main}">${main}</option>`;
      }
    };

    function loadSubService() {
      const main = document.getElementById("mainService").value;
      const subSel = document.getElementById("subService");
      subSel.innerHTML = `<option value="">-- Ch·ªçn d·ªãch v·ª• con --</option>`;
      if (main && serviceConfig[main]) {
        for (let sub in serviceConfig[main]) {
          subSel.innerHTML += `<option value="${sub}">${sub}</option>`;
        }
      }
      document.getElementById("dynamicForm").innerHTML = "";
    }

    function buildForm() {
      const main = document.getElementById("mainService").value;
      const sub = document.getElementById("subService").value;
      const form = document.getElementById("dynamicForm");
      form.innerHTML = "";

      if (!main || !sub) return;

      form.innerHTML += `
        <label>${fieldLabels["ten"]}</label>
        <input type="text" name="ten" required>
      `;

      const fields = serviceConfig[main][sub];
      fields.forEach(f => {
        let label = `<label>${fieldLabels[f]}</label>`;
        let inputHTML = "";

        if (["thoi_gian", "thoi_gian_don", "thoi_diem_can"].includes(f)) {
          inputHTML = `<input type="datetime-local" name="${f}" required>`;
        } else if (["diem_don", "diem_den", "dia_diem"].includes(f)) {
          inputHTML = `
            <div class="row">
              <input type="text" name="${f}" id="${f}_input" required readonly>
              <button type="button" onclick="openMapModal('${f}_input')" style="width:44px; height:44px;">üìç</button>
            </div>
          `;
        } else {
          inputHTML = `<input type="text" name="${f}" placeholder="${fieldLabels[f]}" required>`;
        }

        form.innerHTML += label + inputHTML;
      });

      form.innerHTML += `<button type="submit">G·ª≠i y√™u c·∫ßu</button>`;
    }

    function submitForm(e) {
      e.preventDefault();
      const main = document.getElementById("mainService").value;
      const sub = document.getElementById("subService").value;
      const formData = new FormData(e.target);
      let data = { dich_vu_chinh: main, dich_vu_con: sub };
      formData.forEach((v, k) => data[k] = v);

      fetch("https://zalo.nomahubvn.com/webhook/3fc8afa2-58bc-4d84-b052-ff3ae95ba0a6", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => {
        document.getElementById("messageBox").className = "message success";
        document.getElementById("messageBox").innerText = "‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!";
        document.getElementById("messageBox").style.display = "block";
        e.target.reset();
      })
      .catch(() => {
        document.getElementById("messageBox").className = "message error";
        document.getElementById("messageBox").innerText = "‚ùå L·ªói g·ª≠i d·ªØ li·ªáu!";
        document.getElementById("messageBox").style.display = "block";
      });
    }

    // ======================
    // B·∫£n ƒë·ªì Leaflet modal
    // ======================
    let map, marker, currentInput;
    function openMapModal(inputId) {
      currentInput = inputId;
      document.getElementById("mapModal").style.display = "block";

      if (!map) {
        map = L.map("map").setView([21.0285, 105.8542], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        map.on("click", function (e) {
          const { lat, lng } = e.latlng;
          if (marker) marker.setLatLng([lat, lng]);
          else marker = L.marker([lat, lng]).addTo(map);
          fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
            .then(res => res.json())
            .then(data => {
              const address = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
              document.getElementById("addressDisplay").innerText = address;
              document.getElementById(currentInput).value = address;
            })
            .catch(() => {
              document.getElementById("addressDisplay").innerText = "Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ";
            });
        });
      }
    }

    function closeMapModal() {
      document.getElementById("mapModal").style.display = "none";
    }

    function confirmLocation() {
      closeMapModal();
    }
  </script>
</body>
</html>
