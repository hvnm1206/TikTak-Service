<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1 Bản đồ - 2 Trường</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin: 5px 0 10px; }
    .map { height: 400px; margin: 15px 0; border: 1px solid #ccc; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h2>Đặt dịch vụ</h2>

  <label>Điểm đón:</label>
  <input type="text" id="diem_don" placeholder="Nhập địa chỉ hoặc click bản đồ">

  <label>Điểm đến:</label>
  <input type="text" id="diem_den" placeholder="Nhập địa chỉ hoặc click bản đồ">

  <label>Chỉnh vị trí cho:</label>
  <input type="radio" name="chon" value="don" checked> Điểm đón
  <input type="radio" name="chon" value="den"> Điểm đến

  <div id="map" class="map"></div>

  <script>
    // Khởi tạo bản đồ
    const map = L.map('map').setView([21.0285, 105.8542], 13); // Hà Nội mặc định
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markerDon, markerDen;

    // Hàm geocode: địa chỉ -> latlng
    async function geocode(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data && data[0]) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      }
      return null;
    }

    // Gõ địa chỉ -> cập nhật map
    async function handleInput(field, type) {
      const val = field.value.trim();
      if (!val) return;
      const coords = await geocode(val);
      if (coords) {
        map.setView(coords, 15);
        if (type === "don") {
          if (markerDon) markerDon.remove();
          markerDon = L.marker(coords, {draggable:true}).addTo(map);
          markerDon.on('dragend', e => {
            const pos = e.target.getLatLng();
            field.value = `${pos.lat},${pos.lng}`;
          });
          field.value = coords[0] + "," + coords[1];
        } else {
          if (markerDen) markerDen.remove();
          markerDen = L.marker(coords, {draggable:true, icon: L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"})}).addTo(map);
          markerDen.on('dragend', e => {
            const pos = e.target.getLatLng();
            field.value = `${pos.lat},${pos.lng}`;
          });
          field.value = coords[0] + "," + coords[1];
        }
      }
    }

    document.getElementById("diem_don").addEventListener("change", e => handleInput(e.target, "don"));
    document.getElementById("diem_den").addEventListener("change", e => handleInput(e.target, "den"));

    // Click bản đồ -> đặt marker
    map.on("click", function(e) {
      const selected = document.querySelector('input[name="chon"]:checked').value;
      if (selected === "don") {
        if (markerDon) markerDon.remove();
        markerDon = L.marker(e.latlng, {draggable:true}).addTo(map);
        document.getElementById("diem_don").value = `${e.latlng.lat},${e.latlng.lng}`;
        markerDon.on('dragend', ev => {
          const pos = ev.target.getLatLng();
          document.getElementById("diem_don").value = `${pos.lat},${pos.lng}`;
        });
      } else {
        if (markerDen) markerDen.remove();
        markerDen = L.marker(e.latlng, {draggable:true, icon: L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"})}).addTo(map);
        document.getElementById("diem_den").value = `${e.latlng.lat},${e.latlng.lng}`;
        markerDen.on('dragend', ev => {
          const pos = ev.target.getLatLng();
          document.getElementById("diem_den").value = `${pos.lat},${pos.lng}`;
        });
      }
    });
  </script>
</body>
</html>
